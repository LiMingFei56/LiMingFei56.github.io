## 总线
	总线一般分为内部总线和外部总线

	* 内部总线:在CPU内部,寄存器之间和算术逻辑部件ALU与控制部件之间传输数据所用的
	  总线称为内部总线.
	* 外部总线:常所说的总线指片外部总线,是CPU与内存RAM,ROM和输入/输出设备
	  接口之间进行通讯的通路,也称系统总线.

### 1 外部总线
	外部总线主要包抱3种:数据总线,地址总线,控制总线.
	* 数据总线:数据总线DB是双向三态形式的总线,即它既可以把CPU的数据传送到
	  存储器或输入输出接口等其它部件,也可以将其它部件的数据传送到CPU.
	  数据总线的位数是微型计算机的一个重要指标,通常与微处理的字长相一致.
	  我们说的32位,64位计算机指的就是数据总线.

	* 地址总线:地址总线AB是专门用来传送地址的,由于地址只能从CPU传向外部存
	  储器或I/O端口,以地址总线总是单向三态的,这与数据总线不同
	  .地址总线的位数决定了CPU可直接寻址的内存空间大小.

	* 控制总线:控制总线主要用来传送控制信号和时序信号.控制总线的传送方向
	  由具体控制信号而定,一般是双向的,控制总线的位数要根据系统的
	  实际控制需要而定.其实数据总线和控制总线可以共用。

### 2 控制芯片
	前面我面介绍了总线的分类,在我们的简单模型中.CPU通过总线和存储器之间直
	接进行通信.实际上在现代的计算机中,存在一个控制芯片的模块.
	CPU需要和存储器,I/O设备等进行交互,会有多种不同功能的控制芯片,我们称之
	为控制芯片组(Chipset).

	对于目前的计算机结构来说,控制芯片集成在主板上,典型的有南北桥结构和单芯
	片结构.与芯片相连接的总线可以分为前端总线（FSB）
	、存储总线、IQ总线，扩展总线等。

#### 2.1 南北桥芯片
	* 北桥芯片:它控制着CPU的类型，主板的总线频率，内存控制器，显示核心等。
	  它直接与CPU、内存、显卡、南桥相连，所以它数据量非常大.
	* 前端总线:是将CPU连接到北桥芯片的总线。FSB的频率是指CPU和北桥之间的数
	  据交换速度。速度越快，数据带宽越高，计算机性能越好；
	* 内存总线:是将内存连接到北桥芯片的总线。用于和北桥之间的通信；
	* 显卡总线:是将显卡连接到北桥芯片的总新。目前有AGP,PCI-E等接口。其实并
	  没有显卡总线一说，一般认为属于I/O总线；

	* 南桥芯片:它主要负责外部接口和内部CPU的联系
	* I/O总线 :连接外部I/O设备连接到南桥的总线, 比如USB设备，ATA,SATA设备
	  ，以及一些扩展接口
	* 扩展总线:主要是主板上提供的一些PCI，ISA等插槽；

#### 2.2 单芯片
	单芯片组主要是是取消了北桥，因为现在CPU中内置了内存控制器，不需要再通
	过北桥来控制，这样就能提高内存控制器的频率，减少延迟
	。而现在一些CPU还集成了显示单元。也使得显示芯片的频率更高，延迟更低。

### 3 运行频率
	数据带宽 = （总线频率*数据位宽）/ 8

#### 3.1 外频
	外频是建立在数字脉冲信号震动速度基础上的。它是CPU与系统总线以及其他外
	部设备共同运行的速度。我们知道计算机中有一个时序发生
	器来保证各个部件协同工作，而这里说的外频率就是这个时序发生器的频率。
	外频也是系统总线的工作频率。

#### 3.2 频率和控制芯片
	在计算机刚开始的时候，CPU和内存还有I/O设置是直接通过总线连接的而没有
	控制芯片。所有设备都同步的工作在同一个总线频率下。但是随着CPU的发展，
	CPU速度越来越块。但受限于I/O设备。于是就出现了芯片。他使得I/O总线不在
	直接和CPU的系统总线相连。这样就有了2个不同频率的总线，这个芯片实际起
	到了一个降频的作用，也就相对于系统总线的分频技术。但CPU速度发展相当快
	，CPU的速度已经高于内存运行的速度，于是引入了倍频的概念。CPU在不改变
	外频和系统总线频率的情况下运行在更高的频率。发展到后来，就出现了北桥
	芯片，而CPU和北桥之前的总线称为了FSB总线，而内存与北桥之前称为内存总线。

#### 3.3 分频和倍频
	* 分频：使得I/O设备可以和较高的外频协同工作。比如AGP,PCI总线，运行频率
	在66MHZ和33MHZ，所以对于一个100MHZ的外频来说，采用2/3或1/3分频的方式就
	能使得CPU和外设同步的工作了。否则设备可能无法正常工作。
	* 倍频：为了提高CPU频率又正常的和内存进行工作，所以产生了倍频。所以对
	于CPU来说他实际的频率是外频*倍频。

#### 3.4 FSB频率
	前面我们现在已经知道CPU和北桥芯片连接是通过FSB。而FSB频率表示CPU和北桥
	芯片之间的工作速度。但是从前面我们就知道FSB的实际频率是和外频一样的。
	但是随着技术的发展，Intel的QDR技术和AMD的HT技术，使得CPU在一个时钟周期
	可以传送4次数据，所以对于FSB来说虽然工作早外频的频率下，但是等效的频率
	是外频的4倍。所以我们说的FSB频率是等效频率，而不是实际的工作频率。随着
	技术的发展，Intel芯片的FSB有800MHz，1600HMz等等。但随着北桥芯片的消失
	，FSB的概率也慢慢远去。

#### 3.5 内存频率
	对于内存频率我们可以看到，一般包括了核心频率，总线频率和传输频率：

	* 核心频率和外频类似，是建立在脉冲震荡信号上的。
	* 总线频率就是指内存总线的工作频率。也就是内存和北桥芯片之间的工作频率。
	* 而传输频率类似FSB，是指实际传输数据的频率。

	对于SDR来说，它的3个频率是一致的。而DDR在一个时钟周期可以传送2次数据
	，所以它的传输频率是核心和总线频率的2倍。DDR2在DDR的基础上，采用了4bit
	预读，所以总线频率是核心频率的2倍，而DDR3采用了8bit预读，总线频率是核
	心频率的4倍。通长常说的DDR3 1600是说的传输频率.

	而随着FSB速度不断加快，内存的总线频率组建成为了瓶颈，于是出现了DDR双
	通道，双通道是指芯片拥有2个内存控制器，所以可以使得传输速率翻倍。

### 4 总线工作方式
	因为内存总线频率不同，所以内存和CPU之间存在同步和异步两种工作方式。
	* 同步方式：内存总线频率和CPU外频相同。比如以前的PC133和P3处理器，他们
	  以同步的方式工作在133MHZ下。而当你超频时就需要拥有更高总线频率的内存
	  。当然也需要北桥芯片的支持。
	* 异步方式：内存总线频率和CPU外频不同。睡着CPU外频的提高，内存也必须
	  更新，所以出现了异步的方式。比如P4 CPU外频为200MHz，而内存却可以使用
	  DDR333来运行。同时异步方式也在超频时经常使用。一般来说会有一个内存异
	  步比率。在BIOS中会有相应的选项。
	
#### 4.1 QPI和HT总线技术
	从前面我们知道了FSB对整个系统的性能影响很大，1600MHZ的FSB能提供的数据
	带宽也只有12.8GB/s，所以随着技术的发展，现在最新的计算机基本都采用了
	单芯片设计，北桥的功能被集成到了CPU内部。于是我们前面说的FSB也就不存
	在了。对于Intel和AMD这2大芯片厂商，分别有自己的技术来提高CPU和存储器
	以及其他设备之间的传输速率，满足更高的计算要求。	

	* QPI: Intel的QuickPath Interconnect技术缩写为QPI，译为快速通道互联。
	  用来实现芯片之间的直接互联，而不是在通过FSB连接到北桥。早期20位宽的
	  QPI连接其带宽可达惊人的每秒25.6GB，远非FSB可比。而随着技术发展，在
	  高端安腾处理中峰值可以达到96GB/s。
	* HT：HyperTransport本质是一种为主板上的集成电路互连而设计的端到端总线
	  技术，目的是加快芯片间的数据传输速度。HyperTransport技术在AMD平台上
	  使用后，是指AMD CPU到主板芯片之间的连接总线（如果主板芯片组是南北桥
	  架构，则指CPU到北桥）即HT总线。HT3.1理论上可以达到51.2GB/s。  

### 5 i/o设备
	对于硬件工程师来说，I/O设备是电子芯片、导线、电源、电子控制设备、电机
	等组成的物理设备。而对于程序员来说，关注的只是I/O设备的编程接口。

#### 5.1 I/O设备分类
	* 块设备： 块设备把信息存放在固定大小的块中，每个块都有自己的地址，独
	  立于其他块，可寻址。例如磁盘，USB闪存，CD-ROM等。
	* 符号设备：字符设备以字符为单位接收或发送一个字符流，字符设备不可以寻
	  址。列入打印机、网卡、鼠标键盘等。

#### 5.2 设备控制器
	I/O设备一般由机械部件和电子部件两部分组成。电子设备一般称为设备控制器
    ，在计算机上一般以芯片的形式出现，比如我们前面介绍的南桥芯片。不同的
	控制器可以控制不同的设备。所以南桥芯片中包含了多种设备的控制器，比如
	硬盘控制器，USB控制器，网卡、声卡控制器等等。而通过总线以及卡槽提供和
	设备本身的连接。比如PCI，PCI-E，SATA，USB等。

#### 5.3 驱动程序
	对于不同的设备控制器，进行的操作控制也是不同的。所以需要专门的软件对他
	进行控制。这个软件的作用就是用来专门和设备控制器对话，这种软件称为驱动
	程序。一般来说驱动程序由硬件设别厂商提供。所以我们有时会碰到一些设备因
	为没有安装驱动程序而无法使用的情况。 而目前的OS总都包含了大量的通用驱
	动程序，使得我们在安装完系统后不需要在额外的安装驱动。但是通用的驱动只
	能使用设备的基本功能。

	驱动程序因为是非操作系统厂商开发，并且需要被安装到操作系统并调用，所以
	需要有一个统一的模型来开发驱动程序。否则操作系统是无法操作各式各样的设
	备的。前面我们知道设备非为两大类，所以一般操作系统都定义了这两类设备的
	标准接口。

#### 5.4 内存映射I/O
	每个控制器都有几个寄存器和CPU进行通信。通过写入这些寄存器，可以命令设
	备发送或接受数据，开启或关闭。而通过读这些寄存器就能知道设备的状态。因
	为寄存器数量和大小是有限的，所以设备一般会有一个RAM的缓冲区，来存放一
	些数据。比如硬盘的读写缓存，显卡的显存等。一方面提供数据存放，一方面
	也是提高I/O操作的速度。

	现在的问题是CPU如何和这些设备的寄存器或数据缓冲区进行通信呢？存在两个
	可选方案：
		* 为每个控制器分配一个I/O端口号，所有的控制器可以形成一个I/O端口空
		  间。存放在内存中。一般程序不能访问，而OS通过特殊的指令和端口号来
		  从设备读取或是写入数据。早期计算机基本都是这种方式。
	    * 将所有控制器的寄存器映射到内存空间，于是每个设备的寄存器都有一个
		  唯一的地址。这种称为内存映射I/O。

	另一种方式是两种的结合，寄存器拥有I/O端口，而数据缓冲区则映射到内存空
	间。Pentinum就是使用这种方式，所以在IBM-PC兼容机中，内存的0-640K是I/O
    端口地址，640K-1M的地址是保留给设备数据缓冲区的。(关于内存分布后面文章
	会介绍)

	对于我们程序员来说这两种方案有所不同
	* 对于第一种方式需要使用汇编语言来操作，而第2种方式则可以使用C语言来编
	  程，因为他不需要特殊的指令控制，对待I/O设备和其他普通数据访问方式是
	  相同的。
	* 对于I/O映射方式，不需要特殊的保护机制来组织对I/O的访问，因为OS已经完
	  成了这部分工作，不会把这一段内存地址分配给其他程序。
	* 对于内存可用的指令，也能使用在设备的寄存器上。

	任何技术有有点就会有缺点，I/O内存映射也一样：
	* 前面提到过Cache可以对内存进行缓存，但是如果对I/O映射的地址空间进行缓
	  存就会有问题。所以必须有机制来禁用I/O映射空间缓存，这就
	  增大了OS的复杂性。
	* 另一个问题是，因为发送指令后需要判断是内存还是I/O操作，所以它们需要
	  能够检查全部的内存空间。以前CPU,内存和I/O设备在同一个总线上，所以检
	  查很方便。但是后来为了提高CPU和内存效率，CPU和内存之间有一条高速的总
	  线（比如QPI）。这样I/O设备就无法查看内存地址，因为内存地址总线旁落到
	  了内存和CPU的高速总线上，所以需要一个额外的芯片来处理（北桥芯片，内
	  存控制器的作用），增大了系统的复杂度。

#### 5.5 CPU和I/O设备数据交换方式
	前面已经知道CPU通过内存映射的方式和I/O设备交换数据，但是对于CPU来说，
	无论是从内存还是I/O设备读取数据，都需要把地址放到地址总线上，然后在向
	控制总线传递一个READ信号，还要用一条信号线来表示是从内存还是I/O读取数
	据。因为I/O映射的内存区域是特定的，所以不存在无法区分是内存还是I/O操作
	。目前一共有3种方式进行操作：

	* 程序控制I/O： CPU在向I/O设备发出指令后，通过程序查询方式检查I/O设备
	  是否完成工作，如果完成就读取数据，这种方式缺点是CPU在I/O设备工作时被
	  占用。
	* 中断驱动I/O： CPU是稀缺资源，所以为了提高利用率，减少I/O等待。在I/O
	  设备工作时CPU不再等待，而是进行其他的操作，当I/O设备完成后，通过一个
	  硬件中断信号通知CPU。CPU在来处理接下来的工作，比如读取数据存放到内存
	  。但是每次只能请求一个字节，效率很低。
	* DMA： Direct Memory Access利用一种特性的芯片存在于CPU和I/O设备之间。
	  CPU需要操作I/O设备时只需要发送消息给DMA芯片，后面的事情全部内又DMA来
	  完成，当把所需要数据放入内存后在通知CPU进行操作，整个过程DMA直接和内
	  存总线打交道，而CPU也只需要和DMA芯片和内存交互，大大提高了速度。



